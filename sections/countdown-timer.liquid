{{ 'countdown-timer.css' | asset_url | stylesheet_tag }}
{%- style -%}
.section-{{ section.id }}-padding {
  padding-top: {{ section.settings.padding_top }}px;
  padding-bottom: {{ section.settings.padding_bottom }}px;
}
@media screen and (max-width: 991px) {
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.5 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.5 | round: 0 }}px;
  }
}
{%- endstyle -%}

<div class="color-{{ section.settings.color_scheme }} isolate gradient section-{{ section.id }}-padding">
  <div class="page-width">
    <div class="count_t">
      <div>
        <div class="heading inline-richtext">
          {%- if section.settings.heading != blank -%}
            <h2 class="{{ section.settings.heading_size }}">{{ section.settings.heading }}</h2>
          {%- endif -%}
          {% if section.settings.description != blank %}
            <div class="description {{ section.settings.description_style }} rte">
              {{ section.settings.description }}
            </div>
          {% endif %}
        </div>
        {% if section.settings.button_label != blank %}
          <a 
            {% if section.settings.link == blank %}role="link" aria-disabled="true"{% else %}href="{{ section.settings.link }}"{% endif %} 
            class="timebtn {% if section.settings.button_style == 'link' %}link underlined-link{% elsif section.settings.button_style == 'solid' %}button{% else %}button button--secondary{% endif %}">
            <span>{{ section.settings.button_label | escape }}</span>
          </a>
        {%- endif -%}
      </div>

      <div>
        <div data-date="{{ section.settings.wb_enddate }}" class="section-time countd_all" id="countdown-{{ section.id }}">
          <div class="time main_cdays">
            <span class="count wb_cdays">00</span>
            <span>{{ 'wbcustomlabel.wballtext.time_days' | t }}</span>
          </div>
          <div class="time main_chours">
            <span class="count wb_chours">00</span>
            <span>{{ 'wbcustomlabel.wballtext.time_hour' | t }}</span>
          </div>
          <div class="time main_cminutes">
            <span class="count wb_cminutes">00</span>
            <span>{{ 'wbcustomlabel.wballtext.time_min' | t }}</span>
          </div>
          <div class="time main_cseconds">
            <span class="count wb_cseconds">00</span>
            <span>{{ 'wbcustomlabel.wballtext.time_sec' | t }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const countdownEl = document.querySelector("#countdown-{{ section.id }}");
  if (!countdownEl) return;

  const endDateStr = countdownEl.getAttribute("data-date");
  if (!endDateStr) return;

  const endDate = new Date(endDateStr.replace(/-/g, "/")); // Fix for Safari date parsing
  if (isNaN(endDate)) {
    console.error("Countdown: Invalid date format. Use YYYY-MM-DD HH:MM:SS");
    return;
  }

  function updateCountdown() {
    const now = new Date().getTime();
    const distance = endDate.getTime() - now;

    if (distance <= 0) {
      countdownEl.querySelectorAll(".count").forEach(el => el.textContent = "00");
      clearInterval(timer);
      return;
    }

    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

    countdownEl.querySelector(".wb_cdays").textContent = String(days).padStart(2, "0");
    countdownEl.querySelector(".wb_chours").textContent = String(hours).padStart(2, "0");
    countdownEl.querySelector(".wb_cminutes").textContent = String(minutes).padStart(2, "0");
    countdownEl.querySelector(".wb_cseconds").textContent = String(seconds).padStart(2, "0");
  }

  updateCountdown();
  const timer = setInterval(updateCountdown, 1000);
});
</script>

{% schema %}
{
  "name": "t:sections.countdown-timer.name",
  "tag": "section",
  "disabled_on": { "groups": ["header", "footer", "custom.overlay"] },
  "settings": [
    { "type": "color_scheme", "id": "color_scheme", "label": "t:sections.all.colors.label", "default": "background-1" },
    { "type": "inline_richtext", "id": "heading", "label": "t:sections.all.heading.title", "default": "Countdown timer" },
    { "type": "select", "id": "heading_size", "label": "t:sections.all.heading.size", "options": [{"value":"h2","label":"H2"},{"value":"h1","label":"H1"},{"value":"h0","label":"H0"}], "default": "h2" },
    { "type": "richtext", "id": "description", "default": "<p>Description</p>", "label": "t:sections.all.description.title" },
    { "type": "text", "id": "button_label", "default": "Button label", "label": "t:sections.all.label" },
    { "type": "url", "id": "link", "label": "t:sections.all.link" },
    { "type": "select", "id": "button_style", "label": "t:sections.all.style", "options": [{"value":"link","label":"Link"},{"value":"outline","label":"Outline"},{"value":"solid","label":"Solid"}], "default": "solid" },
    { "type": "text", "id": "wb_enddate", "label": "Countdown Enddatum", "info": "Format: YYYY-MM-DD HH:MM:SS" },
    { "type": "range", "id": "padding_top", "min": 0, "max": 100, "step": 4, "unit": "px", "label": "Padding oben", "default": 60 },
    { "type": "range", "id": "padding_bottom", "min": 0, "max": 100, "step": 4, "unit": "px", "label": "Padding unten", "default": 60 }
  ],
  "presets": [{ "name": "Countdown Timer" }]
}
{% endschema %}
